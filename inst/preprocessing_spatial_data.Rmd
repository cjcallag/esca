---
title: "Preparing Data"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

```{r, message = FALSE}
library(dplyr)
library(ggplot2)
library(sf)
```

## Get Ft. Ord Boundaries

Those boundaries have been made available through the Fort Ord Cleanup Open Data portal, [here](https://fort-ord-cleanup-open-data-cespk.hub.arcgis.com/datasets/installation-historical-area/geoservice?geometry=-122.233%2C36.515%2C-121.354%2C36.708). Luckily, the site provides a REST API; as such, the data can be read in programatically:

```{r}
ft_ord <- sf::st_read("https://maps.fodis.net/server/rest/services/OpenData/AdministrativeBoundaries/FeatureServer/4/query?where=1%3D1&outFields=*&outSR=4326&f=json")

ggplot(data = ft_ord) +
  geom_sf(alpha = 0.5) + 
  theme_minimal()
```

Store it for quick access in R package:

```{r}
save(ft_ord, file = here::here("data/ft_ord.rda"))
```

## Process Roads and Gates

The roads and gates data in this section was initially adquired through OSM and validated by CSUMB graduate students for the purposes of developing a fire prevention plan. These data were provided as `*.shp` files.

```{r}
roads <- sf::st_read(here::here("inst/extdata/roads200522.shp")) %>%
  sf::st_transform(., '+proj=longlat +datum=WGS84') %>%
  dplyr::select(name, inspection_status = insp_stus, date = insp_dt,
                surface_type = srfc, condition = cndtn, 
                turn_around_potential = UTurn, lanes = lns, 
                accessibility = accssblty)
gates <- sf::st_read(here::here("inst/extdata/chris_gates.shp")) %>%
  sf::st_transform(., '+proj=longlat +datum=WGS84') %>%
  dplyr::select(name = NAME, gate_type = gt_typ, width = wdth, 
                agency_locks = agnc_lck, road = rd_name)
```

Before using any data, let's clip the `roads` and `gates` to those within the `ft_ord` boundary:

```{r}
roads <- sf::st_intersection(ft_ord, roads)
gates <- sf::st_intersection(ft_ord, gates)
```

```{r}
ggplot() +
  geom_sf(data = roads, aes(color = surface_type), show.legend = "line") +
  geom_sf(data = gates, color = "black", size = 0.5) +
  geom_sf(data = ft_ord, fill = NA, size = 0.5) +
  labs(colour = "Surface type") +
  theme_minimal() + 
  theme(panel.grid.major = element_line(colour = "transparent"),
        legend.position = "bottom")
``` 

Store it for quick access in R package:

```{r}
roads <- sf::st_zm(roads, drop = TRUE, what = "ZM")
# as per: https://gis.stackexchange.com/questions/253898/adding-a-linestring-by-st-read-in-shiny-leaflet
save(roads, file = here::here("data/roads.rda"))
save(gates, file = here::here("data/gates.rda"))
```


## Collect Parcels

Download the data from the RESTful API:

```{r}
parcels <- sf::st_read("https://services2.arcgis.com/nOGTdfb4kF4dZljH/arcgis/rest/services/Parcels_Data/FeatureServer/0/query?where=1%3D1&outFields=*&outSR=4326&f=json")
```

Clip the data:

```{r}
parcels <- sf::st_intersection(ft_ord, sf::st_make_valid(parcels))
```

```{r}
ggplot() +
  geom_sf(data = parcels, fill = "grey", alpha = 0.1, color = "black") +
  geom_sf(data = ft_ord, fill = NA, size = 0.5) +
  theme_minimal() + 
  theme(panel.grid.major = element_line(colour = "transparent"),
        legend.position = "bottom")
```

Store it for quick access in R package:

```{r}
save(parcels, file = here::here("data/parcels.rda"))
```


### ESCA

Found [here](https://fort-ord-cleanup-open-data-cespk.hub.arcgis.com/datasets/dudded-impact-area-esca-mra/geoservice?geometry=-121.898%2C36.608%2C-121.651%2C36.656)

```{r}
esca <- sf::st_read("https://maps.fodis.net/server/rest/services/OpenData/Environmental/FeatureServer/3/query?where=1%3D1&outFields=*&outSR=4326&f=json")
```

```{r}
plot(esca["imparea_id"])
```


### Fort Ord Parcel Parcels

The layer of parcels per ACE is found [here](https://maps.fodis.net/server/rest/services/FeatureServices/PublicParcels/MapServer/2). In essence, it contains the shapes of the parcels and fields of interest, such as: HMP category, COE number, Parcel recipient, Jurisdiction, etc.

```{r}
fo_parcels <- sf::st_read("https://maps.fodis.net/server/rest/services/FeatureServices/PublicParcels/MapServer/2/query?where=1%3D1&outFields=*&outSR=4326&f=json")
```

```{r}
plot(fo_parcels["FortOrd.DBO.tblParcel.Jurisdiction"])
```

Isolate ESCA parcels:

```{r}
esca_fo_parcels <- fo_parcels[fo_parcels$FortOrd.DBO.tblParcel.TransferDocName == "FOSET 5 (ESCA and Non-ESCA OUCTP)", ]
```

```{r}
plot(esca_fo_parcels["FortOrd.DBO.tblParcel.Jurisdiction"])
```

```{r}
esca_join <- st_join(x = esca_fo_parcels, y = esca)
plot(esca_join["imparea_id"])
```

Clean it up:

```{r}
esca_join <- esca_join[!is.na(esca_join$FortOrd.DBO.PARCEL_AREA.FortOrd_DBO_tblParcel_COENumber), ]
esca_parcels <- esca_join[!is.na(esca_join$imparea_id), ]
plot(esca_parcels["imparea_id"])
```

Store it for quick access in R package:

```{r}
save(esca_parcels, file = here::here("data/esca_parcels.rda"))
```



### Extras

# ```{r}
# test <- sf::st_read("https://maps.fodis.net/server/rest/services/OpenData/AdministrativeBoundaries/FeatureServer/1//query?where=1%3D1&outFields=*&outSR=4326&f=json")
# ```




